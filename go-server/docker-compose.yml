version: '3.8'

services:
  tmdb-go-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-8080}:8080"
    environment:
      - PORT=${PORT:-8080}
      - UPSTREAM_SERVERS=${UPSTREAM_SERVERS}
      - UPSTREAM_TYPE=${UPSTREAM_TYPE:-tmdb-api}
      - TMDB_API_KEY=${TMDB_API_KEY}
      - TMDB_IMAGE_TEST_URL=${TMDB_IMAGE_TEST_URL:-/t/p/original/wwemzKWzjKYJFfCeiB57q3r4Bcm.png}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-30s}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30m}
      - HEALTH_CHECK_INITIAL_DELAY=${HEALTH_CHECK_INITIAL_DELAY:-30s}
      - MAX_ERRORS_BEFORE_UNHEALTHY=${MAX_ERRORS_BEFORE_UNHEALTHY:-3}
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - CACHE_DIR=${CACHE_DIR:-./cache}
      - CACHE_TTL=${CACHE_TTL:-24h}
      - CACHE_MAX_SIZE=${CACHE_MAX_SIZE:-1GB}
      - MEMORY_CACHE_SIZE=${MEMORY_CACHE_SIZE:-1000}
      - MEMORY_CACHE_TTL=${MEMORY_CACHE_TTL:-1h}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CLEAR_HEALTH_DATA=${CLEAR_HEALTH_DATA:-false}
    volumes:
      - ./cache:./cache
      - ./health_data.json:./health_data.json
      - ./connection_rate_data.json:./connection_rate_data.json
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - tmdb-network

networks:
  tmdb-network:
    driver: bridge 