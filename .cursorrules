# Instructions

During you interaction with the user, if you find anything reusable in this project (e.g. version of a library, model name), especially about a fix to a mistake you made or a correction you received, you should take note in the `Lessons` section in the `.cursorrules` file so you will not make the same mistake again. 

You should also use the `.cursorrules` file as a scratchpad to organize your thoughts. Especially when you receive a new task, you should first review the content of the scratchpad, clear old different task if necessary, first explain the task, and plan the steps you need to take to complete the task. You can use todo markers to indicate the progress, e.g.
[X] Task 1
[ ] Task 2
Also update the progress of the task in the Scratchpad when you finish a subtask.
Especially when you finished a milestone, it will help to improve your depth of task accomplishment to use the scratchpad to reflect and plan.
The goal is to help you maintain a big picture as well as the progress of the task. Always refer to the Scratchpad when you plan the next step.

# Lessons

## User Specified Lessons

- You have a python venv in ./venv.
- Include info useful for debugging in the program output.
- Read the file before you try to edit it.
- Use LLM to perform flexible text understanding tasks. First test on a few files. After success, make it parallel.

## Cursor learned

- 添加环境变量配置时，应设计合理的默认值和类型转换处理，如 `CACHE_ENABLED` 默认为 true
- 禁用功能时，应提供空操作（no-op）实现，以避免在其他代码中进行大量条件判断
- LRU缓存类应该提供辅助方法（如 `getContentTypeConfig`）以支持特定内容类型的缓存策略
- 为了保持代码可读性和一致性，在处理缓存时应统一处理不同类型的数据（如Buffer、JSON等）
- 调用可能不存在的方法前应先检查该方法是否存在（如 `typeof obj.method === 'function'`）
- 扩展类的方法接口时，确保所有相关调用都更新了参数列表（如向 `diskCache.set` 添加 contentType 参数）
- 多架构Docker构建时，使用QEMU和Buildx可以同时构建多个架构的镜像，提高部署效率

# Scratchpad

## 当前任务：创建多架构支持Release

任务说明：为用户创建一个新的GitHub Release，内容关于项目新增的多架构支持功能。

计划步骤：
[X] 检查当前版本号
[X] 更新package.json版本号
[X] 创建Release说明文档
[X] 修复Dockerfile构建问题
[ ] 使用GitHub CLI创建Release
[ ] 验证Release创建成功

实现内容：
- 支持 linux/amd64 (Intel/AMD x86_64)
- 支持 linux/arm64 (ARM 64位，Apple Silicon等)
- 支持 linux/arm/v7 (ARM 32位 v7)
- 优化了Dockerfile多阶段构建
- 添加了.dockerignore优化构建
- 创建了专门的release.yml工作流
- 更新了README.md文档

## 之前任务：实现多架构Docker构建支持

[X] 分析现有GitHub Actions工作流
[X] 修改proxy-nest.yml添加多架构支持
[X] 优化Dockerfile支持多阶段构建
[X] 创建.dockerignore文件优化构建
[X] 创建release.yml专门用于版本发布
[X] 更新README.md添加多架构说明

实现总结：
- 使用QEMU和Docker Buildx实现多架构构建
- 支持AMD64、ARM64、ARMv7三种主要架构
- 优化了构建缓存和构建效率
- 添加了健康检查和安全性改进
- 保持了向后兼容性

## 更早任务：修复Authorization头部转发问题

[X] 分析问题：代理服务器没有转发客户端的Authorization头部
[X] 修改 utils.js 中的 tryRequestWithRetries 函数，添加对请求头的支持
[X] 修改 worker.js 中的消息处理，传递请求头参数
[X] 修改 worker.js 中的 handleRequest 函数，接收并传递请求头
[X] 修改 server.js 中的 handleRequestWithWorker 函数，提取并传递请求头

实现总结：
- 添加了对 Authorization、Content-Type、Accept、User-Agent 等关键请求头的转发
- 保持了向后兼容性，没有破坏现有功能
- 现在支持 Bearer Token 认证方式
- 修复了 TMDB API 代理的认证问题 